import os
import logging
from aiogram import Bot, Dispatcher, executor, types
from aiogram.utils.exceptions import ChatNotFound

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway
BOT_TOKEN = os.getenv('BOT_TOKEN') 

# ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (–í–∞—à –ò–Ω—Ñ–æ—Ä–º–∞—Ç–æ—Ä)
CHANNEL_ID = -1003422300617 

# –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª —Å –º–∞–Ω—É–∞–ª–∞–º–∏ (–∫—É–¥–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
MANUAL_CHANNEL_LINK = "https://t.me/+A0NALNA1tltjYjIy" 

# –°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–∞—è, –µ—Å–ª–∏ –±–æ—Ç –Ω–µ –∞–¥–º–∏–Ω)
FALLBACK_CHANNEL_LINK = "https://t.me/+Ycncv5PGWvxjNmZi"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
if not BOT_TOKEN:
    logging.error("BOT_TOKEN is not set!")
    exit(1)
    
bot = Bot(token=BOT_TOKEN, parse_mode=types.ParseMode.MARKDOWN)
dp = Dispatcher(bot)

# –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
CHECK_BUTTON = types.InlineKeyboardMarkup().add(
    types.InlineKeyboardButton(text="‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø", callback_data="check_subscription")
)

# --- –§–£–ù–ö–¶–ò–ò –ü–†–û–í–ï–†–ö–ò ---

async def is_subscribed(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–∞–Ω–∞–ª."""
    try:
        member = await bot.get_chat_member(CHANNEL_ID, user_id)
        # –°—Ç–∞—Ç—É—Å—ã, –æ–∑–Ω–∞—á–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫—É: 'creator', 'administrator', 'member'
        return member.status in ['creator', 'administrator', 'member']
        
    except ChatNotFound:
        logging.error(f"ChatNotFound for ID: {CHANNEL_ID}. Bot is likely not an admin.")
        return False
    except Exception as e:
        logging.error(f"Error checking subscription for user {user_id}: {e}")
        return False

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î –ò –ö–ù–û–ü–û–ö ---

@dp.message_handler(commands=['start'])
async def send_welcome(message: types.Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start."""
    user_id = message.from_user.id
    
    if await is_subscribed(user_id):
        # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω
        await message.reply(
            f"üéâ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!** –í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –Ω–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª.\n\n"
            f"–í–æ—Ç –≤–∞—à–∞ **—Å—Å—ã–ª–∫–∞ –Ω–∞ –º–∞–Ω—É–∞–ª—ã**:\n"
            f"[üöÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞–Ω—É–∞–ª–∞–º]({MANUAL_CHANNEL_LINK})"
        )
    else:
        # –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫—É –∏–∑ Telegram
            channel_info = await bot.get_chat(CHANNEL_ID)
            invite_link = channel_info.invite_link
        except Exception:
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å (–±–æ—Ç –Ω–µ –∞–¥–º–∏–Ω), –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω—É—é —Å—Å—ã–ª–∫—É
            invite_link = FALLBACK_CHANNEL_LINK
            
        await message.reply(
            f"‚úã **–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.**\n\n"
            f"–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∞–Ω—É–∞–ª–∞–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, **–ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª**:\n"
            f"üëâ {invite_link}\n\n"
            f"–ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
            reply_markup=CHECK_BUTTON,
            disable_web_page_preview=True
        )

@dp.callback_query_handler(lambda c: c.data == 'check_subscription')
async def process_callback_check(callback_query: types.CallbackQuery):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏."""
    user_id = callback_query.from_user.id
    
    await bot.answer_callback_query(callback_query.id, text="–ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–¥–ø–∏—Å–∫—É...", show_alert=False)
    
    if await is_subscribed(user_id):
        # –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞
        await bot.send_message(
            user_id,
            f"‚úÖ **–û—Ç–ª–∏—á–Ω–æ!** –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.\n\n"
            f"–í–æ—Ç –≤–∞—à–∞ **—Å—Å—ã–ª–∫–∞ –Ω–∞ –º–∞–Ω—É–∞–ª—ã**:\n"
            f"[üöÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞–Ω—É–∞–ª–∞–º]({MANUAL_CHANNEL_LINK})"
        )
        # –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∞
        await bot.edit_message_text(
            "‚úÖ –î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç! –ù–∞–∂–º–∏—Ç–µ /start, –µ—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–ª–∏ —Å—Å—ã–ª–∫—É.",
            callback_query.from_user.id,
            callback_query.message.message_id
        )
    else:
        # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
        await bot.send_message(user_id, "‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã **–ø–æ–¥–ø–∏—Å–∞–Ω—ã** –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# --- –ó–ê–ü–£–°–ö –ë–û–¢–ê ---

if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)
